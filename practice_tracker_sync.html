<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Practice">
    <meta name="theme-color" content="#333333">
    <title>Music Practice Tracker</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 100%;
            margin: 0;
            padding: 15px;
            background: #f5f5f5;
            -webkit-tap-highlight-color: transparent;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .week-label {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .week-label input {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .sync-section {
            text-align: center;
            margin: 15px 0;
        }
        
        .sync-btn {
            padding: 10px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .sync-btn:active {
            background: #3367d6;
        }
        
        .sync-btn.signed-in {
            background: #34a853;
        }
        
        #syncStatus {
            font-size: 12px;
            margin-top: 5px;
            min-height: 18px;
        }
        
        .tracker {
            background: white;
            border: 2px solid #333;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 2px;
            background: #333;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .cell {
            background: white;
            padding: 12px 4px;
            text-align: center;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        
        .header {
            background: #333;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }
        
        .instrument {
            font-weight: bold;
            text-align: left;
            padding-left: 8px;
            justify-content: flex-start;
            font-size: 10px;
            line-height: 1.2;
        }
        
        .check-cell {
            cursor: pointer;
            font-size: 20px;
            transition: background 0.2s;
            touch-action: manipulation;
        }
        
        .check-cell:active {
            background: #e0e0e0;
        }
        
        .check-cell.checked {
            background: #4CAF50;
            color: white;
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .goal-met {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .goal-not-met {
            color: #ff5722;
        }
        
        button.reset-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 24px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            border-radius: 4px;
            touch-action: manipulation;
        }
        
        button.reset-btn:active {
            background: #555;
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            body {
                max-width: 900px;
                margin: 40px auto;
                padding: 20px;
            }
            
            h1 {
                font-size: 32px;
            }
            
            .grid {
                grid-template-columns: 150px repeat(7, 1fr);
                gap: 1px;
            }
            
            .cell {
                padding: 15px 10px;
                min-height: 40px;
                font-size: 14px;
            }
            
            .header {
                font-size: 14px;
            }
            
            .instrument {
                padding-left: 15px;
                font-size: 14px;
            }
            
            .check-cell {
                font-size: 24px;
            }
            
            .check-cell:hover {
                background: #f0f0f0;
            }
            
            .summary {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <h1>üé∏ Music Practice Tracker</h1>
    <div class="week-label">
        Week of: <input type="date" id="weekDate">
    </div>
    
    <div class="sync-section">
        <button id="authBtn" class="sync-btn" onclick="handleAuth()">Sign in with Google</button>
        <button id="syncBtn" class="sync-btn" onclick="syncData()" style="display:none;">‚òÅÔ∏è Sync Now</button>
        <div id="syncStatus"></div>
    </div>
    
    <div class="tracker">
        <div class="grid" id="practiceGrid">
            <div class="cell header"></div>
            <div class="cell header">Mon</div>
            <div class="cell header">Tue</div>
            <div class="cell header">Wed</div>
            <div class="cell header">Thu</div>
            <div class="cell header">Fri</div>
            <div class="cell header">Sat</div>
            <div class="cell header">Sun</div>
            
            <div class="cell instrument">Electric Guitar</div>
            <div class="cell check-cell" data-instrument="electric" data-day="0"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="1"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="2"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="3"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="4"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="5"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="6"></div>
            
            <div class="cell instrument">Classical Guitar</div>
            <div class="cell check-cell" data-instrument="classical" data-day="0"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="1"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="2"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="3"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="4"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="5"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="6"></div>
            
            <div class="cell instrument">Bass</div>
            <div class="cell check-cell" data-instrument="bass" data-day="0"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="1"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="2"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="3"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="4"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="5"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="6"></div>
            
            <div class="cell instrument">Piano</div>
            <div class="cell check-cell" data-instrument="piano" data-day="0"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="1"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="2"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="3"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="4"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="5"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="6"></div>
        </div>
        
        <div class="summary" id="summary">
            <strong>Weekly Progress:</strong>
            <div class="summary-row">
                <span>Electric Guitar:</span>
                <span id="electric-count">0 / 3</span>
            </div>
            <div class="summary-row">
                <span>Classical Guitar:</span>
                <span id="classical-count">0 / 3</span>
            </div>
            <div class="summary-row">
                <span>Bass:</span>
                <span id="bass-count">0 / 3</span>
            </div>
            <div class="summary-row">
                <span>Piano:</span>
                <span id="piano-count">0 / 3</span>
            </div>
            <div class="summary-row" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #333;">
                <span>Daily practice sessions:</span>
                <span id="daily-count">0 days with 2+ instruments</span>
            </div>
        </div>
    </div>
    
    <button class="reset-btn" onclick="resetTracker()">Reset Week</button>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const CLIENT_ID = '90415557909-pgkuol7snj6s4o4tqrk2p0f8oginu53s.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA82u5qKmYkXl5cdBoYvQEizzdkgsi_ZR4';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const FILE_NAME = 'music_practice_data.json';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let fileId = null;
        
        // Set current week
        document.getElementById('weekDate').valueAsDate = new Date();
        
        // Practice data management
        let practiceData = loadLocalData();
        
        function loadLocalData() {
            const saved = localStorage.getItem('musicPractice');
            if (saved) {
                return JSON.parse(saved);
            }
            return {};
        }
        
        function saveLocalData(data) {
            localStorage.setItem('musicPractice', JSON.stringify(data));
        }
        
        // Restore checked states
        function renderData() {
            document.querySelectorAll('.check-cell').forEach(cell => {
                const instrument = cell.dataset.instrument;
                const day = cell.dataset.day;
                const key = `${instrument}-${day}`;
                
                if (practiceData[key]) {
                    cell.classList.add('checked');
                    cell.textContent = '‚úì';
                } else {
                    cell.classList.remove('checked');
                    cell.textContent = '';
                }
            });
            updateSummary();
        }
        
        // Click handler
        document.querySelectorAll('.check-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                const instrument = this.dataset.instrument;
                const day = this.dataset.day;
                const key = `${instrument}-${day}`;
                
                this.classList.toggle('checked');
                
                if (this.classList.contains('checked')) {
                    this.textContent = '‚úì';
                    practiceData[key] = true;
                } else {
                    this.textContent = '';
                    delete practiceData[key];
                }
                
                saveLocalData(practiceData);
                updateSummary();
                
                // Auto-sync if signed in
                if (accessToken) {
                    syncData();
                }
            });
        });
        
        function updateSummary() {
            const instruments = ['electric', 'classical', 'bass', 'piano'];
            
            instruments.forEach(instrument => {
                let count = 0;
                for (let day = 0; day < 7; day++) {
                    const key = `${instrument}-${day}`;
                    if (practiceData[key]) count++;
                }
                
                const countEl = document.getElementById(`${instrument}-count`);
                countEl.textContent = `${count} / 3`;
                
                if (count >= 3) {
                    countEl.className = 'goal-met';
                } else {
                    countEl.className = 'goal-not-met';
                }
            });
            
            // Count days with 2+ instruments
            let daysWithTwoPlus = 0;
            for (let day = 0; day < 7; day++) {
                let instrumentsToday = 0;
                instruments.forEach(instrument => {
                    if (practiceData[`${instrument}-${day}`]) {
                        instrumentsToday++;
                    }
                });
                if (instrumentsToday >= 2) daysWithTwoPlus++;
            }
            
            document.getElementById('daily-count').textContent = 
                `${daysWithTwoPlus} days with 2+ instruments`;
        }
        
        function resetTracker() {
            if (confirm('Reset this week? This will clear all checkmarks.')) {
                practiceData = {};
                saveLocalData(practiceData);
                renderData();
                
                if (accessToken) {
                    syncData();
                }
            }
        }
        
        // Google Drive integration
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
        }
        
        function handleAuth() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showStatus('Auth failed', 'error');
                    return;
                }
                
                accessToken = gapi.client.getToken().access_token;
                document.getElementById('authBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'inline-block';
                document.getElementById('syncBtn').classList.add('signed-in');
                showStatus('‚úì Signed in', 'success');
                
                // Load data from Drive
                await loadFromDrive();
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function findOrCreateFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }
                
                // Create new file
                const fileMetadata = {
                    name: FILE_NAME,
                    mimeType: 'application/json'
                };
                
                const createResponse = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });
                
                return createResponse.result.id;
            } catch (err) {
                console.error('Error finding/creating file:', err);
                showStatus('Error accessing Drive', 'error');
                return null;
            }
        }
        
        async function loadFromDrive() {
            showStatus('Loading from Drive...', 'loading');
            
            try {
                fileId = await findOrCreateFile();
                if (!fileId) return;
                
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                if (response.body) {
                    practiceData = JSON.parse(response.body);
                    saveLocalData(practiceData);
                    renderData();
                    showStatus('‚úì Loaded from Drive', 'success');
                }
            } catch (err) {
                // File might be empty or not exist yet
                console.log('No existing data or error loading:', err);
                showStatus('‚úì Ready to sync', 'success');
            }
        }
        
        async function syncData() {
            if (!accessToken) {
                showStatus('Please sign in first', 'error');
                return;
            }
            
            showStatus('Syncing...', 'loading');
            
            try {
                if (!fileId) {
                    fileId = await findOrCreateFile();
                }
                
                const dataStr = JSON.stringify(practiceData, null, 2);
                
                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: dataStr
                });
                
                if (response.ok) {
                    showStatus('‚úì Synced', 'success');
                } else {
                    showStatus('Sync failed', 'error');
                }
            } catch (err) {
                console.error('Sync error:', err);
                showStatus('Sync error', 'error');
            }
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.style.color = type === 'error' ? '#ff5722' : type === 'success' ? '#4CAF50' : '#666';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
            }
        }
        
        // Check if already signed in
        window.addEventListener('load', () => {
            if (window.gapi) gapiLoaded();
            if (window.google) gisLoaded();
            renderData();
        });
    </script>
</body>
</html>