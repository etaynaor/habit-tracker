<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Practice">
    <meta name="theme-color" content="#333333">
    <title>Music Practice Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🎸</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23667eea'/><text x='50' y='70' text-anchor='middle' font-size='60'>🎸</text></svg>">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 100%;
            margin: 0;
            padding: 15px;
            background: #f5f5f5;
            -webkit-tap-highlight-color: transparent;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .header-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .week-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .week-display label {
            font-size: 14px;
            color: #666;
        }

        .week-display input {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .week-range {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
        }

        .nav-btn {
            padding: 8px 14px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .nav-btn:hover {
            background: #e0e0e0;
        }

        .nav-btn:active {
            background: #d0d0d0;
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .sync-btn {
            padding: 10px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .sync-btn:active {
            background: #3367d6;
        }
        
        .sync-btn.signed-in {
            background: #34a853;
        }
        
        #syncStatus {
            font-size: 11px;
            margin-top: 3px;
            min-height: 16px;
            opacity: 0.8;
        }
        
        .tracker {
            background: white;
            border: 2px solid #333;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 2px;
            background: #333;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .cell {
            background: white;
            padding: 12px 4px;
            text-align: center;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        
        .header {
            background: #333;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }
        
        .instrument {
            font-weight: bold;
            text-align: left;
            padding-left: 8px;
            justify-content: flex-start;
            font-size: 10px;
            line-height: 1.2;
        }
        
        .check-cell {
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            touch-action: manipulation;
            position: relative;
        }

        .check-cell:active {
            transform: scale(0.95);
        }

        .check-cell.checked {
            background: #4CAF50;
            color: white;
            animation: checkBounce 0.5s ease;
        }

        .check-cell.just-checked {
            animation: checkPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes checkBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes checkPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(-5deg); }
            75% { transform: scale(1.05) rotate(5deg); }
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .goal-met {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .goal-not-met {
            color: #ff5722;
        }

        .streak-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }

        .streak-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .streak-icon {
            font-size: 48px;
            animation: flicker 2s ease-in-out infinite;
        }

        @keyframes flicker {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .streak-info {
            text-align: center;
        }

        .streak-number {
            font-size: 48px;
            font-weight: bold;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .streak-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .streak-description {
            text-align: center;
            font-size: 12px;
            opacity: 0.8;
        }

        button.reset-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 24px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            border-radius: 4px;
            touch-action: manipulation;
        }
        
        button.reset-btn:active {
            background: #555;
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            body {
                max-width: 900px;
                margin: 40px auto;
                padding: 20px;
            }
            
            h1 {
                font-size: 32px;
            }

            .header-controls {
                flex-direction: row;
                justify-content: space-between;
                margin-bottom: 30px;
            }

            .week-display label {
                font-size: 16px;
            }

            .week-display input {
                padding: 10px 14px;
                font-size: 15px;
            }

            .nav-btn {
                padding: 10px 16px;
                font-size: 18px;
            }

            .grid {
                grid-template-columns: 150px repeat(7, 1fr);
                gap: 1px;
            }
            
            .cell {
                padding: 15px 10px;
                min-height: 40px;
                font-size: 14px;
            }
            
            .header {
                font-size: 14px;
            }
            
            .instrument {
                padding-left: 15px;
                font-size: 14px;
            }
            
            .check-cell {
                font-size: 24px;
            }
            
            .check-cell:hover {
                background: #f0f0f0;
            }
            
            .summary {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <h1>🎸 Music Practice Tracker</h1>

    <div class="header-controls">
        <div class="week-navigation">
            <button class="nav-btn" onclick="previousWeek()">◀</button>
            <div class="week-display">
                <label>Week of:</label>
                <input type="date" id="weekDate" onchange="updateWeekDisplay()">
                <div class="week-range" id="weekRange"></div>
            </div>
            <button class="nav-btn" onclick="nextWeek()">▶</button>
        </div>

        <div class="auth-section">
            <button id="authBtn" class="sync-btn" onclick="handleAuth()" disabled>Loading...</button>
            <div id="syncStatus"></div>
        </div>
    </div>
    
    <div class="tracker">
        <div class="grid" id="practiceGrid">
            <div class="cell header"></div>
            <div class="cell header">Mon</div>
            <div class="cell header">Tue</div>
            <div class="cell header">Wed</div>
            <div class="cell header">Thu</div>
            <div class="cell header">Fri</div>
            <div class="cell header">Sat</div>
            <div class="cell header">Sun</div>
            
            <div class="cell instrument">Electric Guitar</div>
            <div class="cell check-cell" data-instrument="electric" data-day="0"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="1"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="2"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="3"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="4"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="5"></div>
            <div class="cell check-cell" data-instrument="electric" data-day="6"></div>
            
            <div class="cell instrument">Classical Guitar</div>
            <div class="cell check-cell" data-instrument="classical" data-day="0"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="1"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="2"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="3"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="4"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="5"></div>
            <div class="cell check-cell" data-instrument="classical" data-day="6"></div>
            
            <div class="cell instrument">Bass</div>
            <div class="cell check-cell" data-instrument="bass" data-day="0"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="1"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="2"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="3"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="4"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="5"></div>
            <div class="cell check-cell" data-instrument="bass" data-day="6"></div>
            
            <div class="cell instrument">Piano</div>
            <div class="cell check-cell" data-instrument="piano" data-day="0"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="1"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="2"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="3"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="4"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="5"></div>
            <div class="cell check-cell" data-instrument="piano" data-day="6"></div>
        </div>
        
        <div class="summary" id="summary">
            <strong>Weekly Progress:</strong>
            <div class="summary-row">
                <span>Electric Guitar:</span>
                <span id="electric-count">0 / 3</span>
            </div>
            <div class="summary-row">
                <span>Classical Guitar:</span>
                <span id="classical-count">0 / 3</span>
            </div>
            <div class="summary-row">
                <span>Bass:</span>
                <span id="bass-count">0 / 3</span>
            </div>
            <div class="summary-row">
                <span>Piano:</span>
                <span id="piano-count">0 / 3</span>
            </div>
            <div class="summary-row" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #333;">
                <span>Multi-instrument days:</span>
                <span id="daily-count">0 / 7 days</span>
            </div>
        </div>

        <div class="streak-section">
            <div class="streak-box">
                <div class="streak-icon">🔥</div>
                <div class="streak-info">
                    <div class="streak-number" id="streak-number">0</div>
                    <div class="streak-label">Week Streak</div>
                </div>
            </div>
            <div class="streak-description" id="streak-description">
                Complete all 4 weekly goals to build your streak!
            </div>
        </div>
    </div>

    <button class="reset-btn" onclick="resetTracker()">Reset Week</button>

    <script>
        // Define callbacks before loading external scripts
        const CLIENT_ID = '90415557909-pgkuol7snj6s4o4tqrk2p0f8oginu53s.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA82u5qKmYkXl5cdBoYvQEizzdkgsi_ZR4';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const FILE_NAME = 'music_practice_data.json';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let fileId = null;

        function gapiLoaded() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    });
                    gapiInited = true;
                    console.log('GAPI initialized');
                    updateAuthButton();
                } catch (err) {
                    console.error('Error initializing GAPI:', err);
                    showStatus('Error loading Google APIs', 'error');
                }
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: '',
            });
            gisInited = true;
            console.log('GIS initialized');
            updateAuthButton();
        }

        function updateAuthButton() {
            if (gapiInited && gisInited) {
                // Check if there's an existing valid token
                const token = gapi.client.getToken();
                if (token !== null && token.access_token) {
                    // We have a valid token from the session
                    console.log('Found existing token, using it');
                    accessToken = token.access_token;
                    updateSignedInUI();
                    loadFromDrive();
                } else {
                    // No valid token, show sign-in button
                    console.log('No valid token found, showing sign-in button');
                    const wasSignedInBefore = localStorage.getItem('googleSignedIn') === 'true';
                    document.getElementById('authBtn').textContent = wasSignedInBefore ? 'Sign in again' : 'Sign in with Google';
                    document.getElementById('authBtn').disabled = false;
                }
            }
        }

        function updateSignedInUI() {
            document.getElementById('authBtn').textContent = '✓ Signed in';
            document.getElementById('authBtn').classList.add('signed-in');
            document.getElementById('authBtn').disabled = true;
            showStatus('Auto-sync enabled', 'success');
        }
    </script>

    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        // Set current week - iOS compatible
        function setDateInputValue(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        document.getElementById('weekDate').value = setDateInputValue(new Date());
        
        // Practice data management - store per week
        let allWeeksData = loadAllWeeksData();
        let practiceData = {}; // Current week's data

        function loadAllWeeksData() {
            const saved = localStorage.getItem('musicPractice');
            if (saved) {
                const data = JSON.parse(saved);
                // Migrate old format to new format if needed
                if (!data.weeks) {
                    // Old format - convert it
                    const weekKey = getWeekKey();
                    return { weeks: { [weekKey]: data } };
                }
                return data;
            }
            return { weeks: {} };
        }

        function saveAllWeeksData() {
            localStorage.setItem('musicPractice', JSON.stringify(allWeeksData));
        }

        function loadWeekData() {
            const weekKey = getWeekKey();
            practiceData = allWeeksData.weeks[weekKey] || {};
            console.log('Loaded week:', weekKey, 'Data:', practiceData);
        }

        function saveWeekData() {
            const weekKey = getWeekKey();
            allWeeksData.weeks[weekKey] = practiceData;
            saveAllWeeksData();
        }

        // Streak management
        let streakData = loadStreakData();

        function loadStreakData() {
            const saved = localStorage.getItem('streakData');
            if (saved) {
                return JSON.parse(saved);
            }
            return { completedWeeks: [], currentStreak: 0, longestStreak: 0 };
        }

        function saveStreakData(data) {
            localStorage.setItem('streakData', JSON.stringify(data));
        }

        function getWeekKey() {
            const date = new Date(document.getElementById('weekDate').value + 'T00:00:00'); // iOS fix
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${weekNum}`;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function checkWeekCompletion() {
            const instruments = ['electric', 'classical', 'bass', 'piano'];
            let allGoalsMet = true;

            instruments.forEach(instrument => {
                let count = 0;
                for (let day = 0; day < 7; day++) {
                    const key = `${instrument}-${day}`;
                    if (practiceData[key]) count++;
                }
                if (count < 3) allGoalsMet = false;
            });

            const weekKey = getWeekKey();
            const wasCompleted = streakData.completedWeeks.includes(weekKey);

            if (allGoalsMet && !wasCompleted) {
                // Week just completed!
                streakData.completedWeeks.push(weekKey);
                updateStreak();
                saveStreakData(streakData);

                // Big celebration!
                setTimeout(() => {
                    playCelebrationSound();
                    createConfetti();
                    showStreakAchievement();
                }, 500);
            } else if (!allGoalsMet && wasCompleted) {
                // Week uncompleted (user unchecked something)
                streakData.completedWeeks = streakData.completedWeeks.filter(w => w !== weekKey);
                updateStreak();
                saveStreakData(streakData);
            }
        }

        function updateStreak() {
            // Sort completed weeks
            const sorted = streakData.completedWeeks.sort();

            if (sorted.length === 0) {
                streakData.currentStreak = 0;
                updateStreakDisplay();
                return;
            }

            // Calculate current streak (consecutive weeks ending at current/recent week)
            let streak = 1;
            for (let i = sorted.length - 1; i > 0; i--) {
                const current = parseWeekKey(sorted[i]);
                const prev = parseWeekKey(sorted[i - 1]);

                if (current.week - prev.week === 1 || (current.week === 1 && prev.week === 52)) {
                    streak++;
                } else {
                    break;
                }
            }

            streakData.currentStreak = streak;
            if (streak > streakData.longestStreak) {
                streakData.longestStreak = streak;
            }

            updateStreakDisplay();
        }

        function parseWeekKey(weekKey) {
            const [year, week] = weekKey.split('-W');
            return { year: parseInt(year), week: parseInt(week) };
        }

        function updateStreakDisplay() {
            document.getElementById('streak-number').textContent = streakData.currentStreak;

            const desc = document.getElementById('streak-description');
            if (streakData.currentStreak === 0) {
                desc.textContent = 'Complete all 4 weekly goals to start your streak!';
            } else if (streakData.currentStreak === 1) {
                desc.textContent = '🎉 Great start! Keep going!';
            } else if (streakData.currentStreak < 4) {
                desc.textContent = `💪 ${streakData.currentStreak} weeks strong! Keep it up!`;
            } else if (streakData.currentStreak < 10) {
                desc.textContent = `🔥 On fire! ${streakData.currentStreak} weeks in a row!`;
            } else {
                desc.textContent = `⭐️ LEGENDARY! ${streakData.currentStreak} week streak! (Best: ${streakData.longestStreak})`;
            }
        }

        function showStreakAchievement() {
            const achievement = document.createElement('div');
            achievement.style.position = 'fixed';
            achievement.style.top = '50%';
            achievement.style.left = '50%';
            achievement.style.transform = 'translate(-50%, -50%)';
            achievement.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            achievement.style.color = 'white';
            achievement.style.padding = '40px 60px';
            achievement.style.borderRadius = '20px';
            achievement.style.fontSize = '32px';
            achievement.style.fontWeight = 'bold';
            achievement.style.zIndex = '10000';
            achievement.style.boxShadow = '0 20px 60px rgba(0,0,0,0.4)';
            achievement.style.animation = 'celebration 0.6s ease';
            achievement.style.textAlign = 'center';

            const streakNum = streakData.currentStreak;
            achievement.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 10px;">🔥</div>
                <div>${streakNum} WEEK STREAK!</div>
                <div style="font-size: 18px; margin-top: 10px; opacity: 0.9;">All goals completed!</div>
            `;

            document.body.appendChild(achievement);

            setTimeout(() => {
                achievement.style.opacity = '0';
                achievement.style.transition = 'opacity 0.5s';
                setTimeout(() => achievement.remove(), 500);
            }, 3000);
        }

        // Sound effects using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playCheckSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playUncheckSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 400;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playCelebrationSound() {
            const notes = [523, 659, 784, 1047]; // C, E, G, C
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = freq;
                oscillator.type = 'triangle';

                const startTime = audioContext.currentTime + (index * 0.1);
                gainNode.gain.setValueAtTime(0.2, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);

                oscillator.start(startTime);
                oscillator.stop(startTime + 0.2);
            });
        }

        // Confetti effect
        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.top = '-10px';
                confetti.style.opacity = '1';
                confetti.style.pointerEvents = 'none';
                confetti.style.zIndex = '9999';
                confetti.style.borderRadius = '50%';

                document.body.appendChild(confetti);

                const duration = Math.random() * 3 + 2;
                const rotation = Math.random() * 360;
                const xOffset = (Math.random() - 0.5) * 200;

                confetti.animate([
                    {
                        transform: `translateY(0) translateX(0) rotate(0deg)`,
                        opacity: 1
                    },
                    {
                        transform: `translateY(${window.innerHeight + 10}px) translateX(${xOffset}px) rotate(${rotation}deg)`,
                        opacity: 0
                    }
                ], {
                    duration: duration * 1000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                });

                setTimeout(() => confetti.remove(), duration * 1000);
            }
        }

        // Week navigation
        function previousWeek() {
            const dateInput = document.getElementById('weekDate');
            const currentDate = new Date(dateInput.value + 'T00:00:00'); // iOS fix
            currentDate.setDate(currentDate.getDate() - 7);
            dateInput.value = setDateInputValue(currentDate);
            console.log('Previous week clicked, new date:', dateInput.value);
            updateWeekDisplay();
        }

        function nextWeek() {
            const dateInput = document.getElementById('weekDate');
            const currentDate = new Date(dateInput.value + 'T00:00:00'); // iOS fix
            currentDate.setDate(currentDate.getDate() + 7);
            dateInput.value = setDateInputValue(currentDate);
            console.log('Next week clicked, new date:', dateInput.value);
            updateWeekDisplay();
        }

        function updateWeekDisplay() {
            // Load the new week's data
            loadWeekData();
            // Re-render the grid with the new week's data
            renderData();
            // Update streak display
            updateStreak();
            // Update week range display
            updateWeekRangeDisplay();
            console.log('Week changed to:', document.getElementById('weekDate').value);
        }

        function updateWeekRangeDisplay() {
            const date = new Date(document.getElementById('weekDate').value + 'T00:00:00'); // iOS fix
            const dayOfWeek = date.getDay();
            const monday = new Date(date);
            monday.setDate(date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            const formatDate = (d) => {
                const month = d.toLocaleDateString('en-US', { month: 'short' });
                const day = d.getDate();
                return `${month} ${day}`;
            };

            document.getElementById('weekRange').textContent =
                `${formatDate(monday)} - ${formatDate(sunday)}`;
        }

        // Restore checked states
        function renderData() {
            document.querySelectorAll('.check-cell').forEach(cell => {
                const instrument = cell.dataset.instrument;
                const day = cell.dataset.day;
                const key = `${instrument}-${day}`;
                
                if (practiceData[key]) {
                    cell.classList.add('checked');
                    cell.textContent = '✓';
                } else {
                    cell.classList.remove('checked');
                    cell.textContent = '';
                }
            });
            updateSummary();
        }
        
        // Track previous goal states for celebration triggers
        let previousGoalStates = {};

        // Click handler
        document.querySelectorAll('.check-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                const instrument = this.dataset.instrument;
                const day = this.dataset.day;
                const key = `${instrument}-${day}`;

                const wasChecked = this.classList.contains('checked');
                this.classList.toggle('checked');

                if (this.classList.contains('checked')) {
                    this.textContent = '✓';
                    practiceData[key] = true;
                    playCheckSound();

                    // Add pop animation
                    this.classList.add('just-checked');
                    setTimeout(() => this.classList.remove('just-checked'), 400);
                } else {
                    this.textContent = '';
                    delete practiceData[key];
                    playUncheckSound();
                }

                saveWeekData(practiceData);

                // Check if goal was just achieved
                const goalAchieved = checkForNewGoals(instrument);
                if (goalAchieved && !wasChecked) {
                    playCelebrationSound();
                    createConfetti();
                    showAchievement(instrument);
                }

                updateSummary();

                // Auto-sync if signed in
                if (accessToken) {
                    syncData();
                }
            });
        });

        function checkForNewGoals(instrument) {
            let count = 0;
            for (let day = 0; day < 7; day++) {
                const key = `${instrument}-${day}`;
                if (practiceData[key]) count++;
            }

            const wasGoalMet = previousGoalStates[instrument] || false;
            const isGoalMet = count >= 3;
            previousGoalStates[instrument] = isGoalMet;

            return isGoalMet && !wasGoalMet;
        }

        function showAchievement(instrument) {
            const achievement = document.createElement('div');
            achievement.style.position = 'fixed';
            achievement.style.top = '50%';
            achievement.style.left = '50%';
            achievement.style.transform = 'translate(-50%, -50%)';
            achievement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            achievement.style.color = 'white';
            achievement.style.padding = '30px 50px';
            achievement.style.borderRadius = '15px';
            achievement.style.fontSize = '24px';
            achievement.style.fontWeight = 'bold';
            achievement.style.zIndex = '10000';
            achievement.style.boxShadow = '0 10px 40px rgba(0,0,0,0.3)';
            achievement.style.animation = 'celebration 0.6s ease';

            const instrumentNames = {
                'electric': 'Electric Guitar',
                'classical': 'Classical Guitar',
                'bass': 'Bass',
                'piano': 'Piano'
            };

            achievement.textContent = `🎉 ${instrumentNames[instrument]} Goal Achieved! 🎉`;
            document.body.appendChild(achievement);

            setTimeout(() => {
                achievement.style.opacity = '0';
                achievement.style.transition = 'opacity 0.5s';
                setTimeout(() => achievement.remove(), 500);
            }, 2000);
        }
        
        function updateSummary() {
            const instruments = ['electric', 'classical', 'bass', 'piano'];
            
            instruments.forEach(instrument => {
                let count = 0;
                for (let day = 0; day < 7; day++) {
                    const key = `${instrument}-${day}`;
                    if (practiceData[key]) count++;
                }
                
                const countEl = document.getElementById(`${instrument}-count`);
                countEl.textContent = `${count} / 3`;
                
                if (count >= 3) {
                    countEl.className = 'goal-met';
                } else {
                    countEl.className = 'goal-not-met';
                }
            });
            
            // Count days with 2+ instruments
            let daysWithTwoPlus = 0;
            for (let day = 0; day < 7; day++) {
                let instrumentsToday = 0;
                instruments.forEach(instrument => {
                    if (practiceData[`${instrument}-${day}`]) {
                        instrumentsToday++;
                    }
                });
                if (instrumentsToday >= 2) daysWithTwoPlus++;
            }
            
            document.getElementById('daily-count').textContent =
                `${daysWithTwoPlus} / 7 days`;

            // Check for week completion and update streak
            checkWeekCompletion();
        }
        
        function resetTracker() {
            if (confirm('Reset this week? This will clear all checkmarks.')) {
                practiceData = {};
                saveWeekData(practiceData);
                renderData();
                
                if (accessToken) {
                    syncData();
                }
            }
        }
        function handleAuth() {
            if (!gapiInited || !gisInited) {
                showStatus('Loading... please wait', 'error');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showStatus('Auth failed', 'error');
                    return;
                }

                accessToken = gapi.client.getToken().access_token;
                localStorage.setItem('googleSignedIn', 'true');
                updateSignedInUI();

                // Load data from Drive
                await loadFromDrive();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function findOrCreateFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }
                
                // Create new file
                const fileMetadata = {
                    name: FILE_NAME,
                    mimeType: 'application/json'
                };
                
                const createResponse = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });
                
                return createResponse.result.id;
            } catch (err) {
                console.error('Error finding/creating file:', err);
                showStatus('Error accessing Drive', 'error');
                return null;
            }
        }
        
        async function loadFromDrive() {
            showStatus('Loading from Drive...', 'loading');

            try {
                fileId = await findOrCreateFile();
                if (!fileId) return;

                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });

                if (response.body) {
                    const driveData = JSON.parse(response.body);
                    // Merge with local data (prefer Drive data)
                    allWeeksData = driveData;
                    saveAllWeeksData();
                    // Load current week
                    loadWeekData();
                    renderData();
                    showStatus('✓ Loaded from Drive', 'success');
                }
            } catch (err) {
                // File might be empty or not exist yet
                console.log('No existing data or error loading:', err);
                showStatus('✓ Ready to sync', 'success');
            }
        }
        
        async function syncData() {
            if (!accessToken) {
                showStatus('Please sign in first', 'error');
                return;
            }
            
            showStatus('Syncing...', 'loading');
            
            try {
                if (!fileId) {
                    fileId = await findOrCreateFile();
                }
                
                const dataStr = JSON.stringify(allWeeksData, null, 2);
                
                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: dataStr
                });
                
                if (response.ok) {
                    showStatus('✓ Synced', 'success');
                } else {
                    showStatus('Sync failed', 'error');
                }
            } catch (err) {
                console.error('Sync error:', err);
                showStatus('Sync error', 'error');
            }
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.style.color = type === 'error' ? '#ff5722' : type === 'success' ? '#4CAF50' : '#999';

            if (type === 'success' || type === 'loading') {
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 2000);
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            loadWeekData(); // Load current week's data
            renderData();
            updateStreak();
            updateWeekRangeDisplay(); // Show week range
        });
    </script>
</body>
</html>