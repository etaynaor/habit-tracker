<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Practice">
    <meta name="theme-color" content="#8B5CF6">
    <title>Music Practice Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üé∏</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%238B5CF6'/><text x='50' y='70' text-anchor='middle' font-size='60'>üé∏</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Dark mode variables */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-primary: #8B5CF6;
            --accent-secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        .dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dark-mode .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-pink {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .gradient-purple {
            background: linear-gradient(135deg, #8B5CF6 0%, #ec4899 100%);
        }

        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Smooth animations */
        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes checkPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(-5deg); }
            75% { transform: scale(1.05) rotate(5deg); }
        }

        @keyframes flicker {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .animate-slide-in-up {
            animation: slideInUp 0.3s ease-out;
        }

        .animate-slide-in-down {
            animation: slideInDown 0.3s ease-out;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideInUp 0.3s ease-out;
            max-width: 400px;
        }

        .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .toast.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }

        /* Check cell styling */
        .check-cell {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            touch-action: manipulation;
            position: relative;
            border-radius: 8px;
            font-size: 24px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
        }

        .check-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .check-cell:active {
            transform: scale(0.95);
        }

        .check-cell.checked {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .check-cell.just-checked {
            animation: checkPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        /* Tabs */
        .tab {
            cursor: pointer;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab:hover {
            background: var(--bg-tertiary);
        }

        .tab.active {
            background: var(--accent-primary);
            color: white;
        }

        /* Heatmap */
        .heatmap-day {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            transition: all 0.2s;
        }

        .heatmap-day:hover {
            transform: scale(1.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .heatmap-day.level-0 { background: var(--bg-tertiary); }
        .heatmap-day.level-1 { background: #9ae6b4; }
        .heatmap-day.level-2 { background: #48bb78; }
        .heatmap-day.level-3 { background: #2f855a; }
        .heatmap-day.level-4 { background: #22543d; }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Button styles */
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #7c3aed);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        /* Stat card */
        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        /* Instrument icons */
        .instrument-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 20px;
        }

        .icon-electric { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .icon-classical { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .icon-bass { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .icon-piano { background: linear-gradient(135deg, #ec4899, #db2777); }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen">
    <!-- Main Container -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 animate-slide-in-down">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-purple rounded-xl flex items-center justify-center text-3xl">
                        üé∏
                    </div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold" style="color: var(--text-primary);">Music Practice Tracker</h1>
                        <p class="text-sm" style="color: var(--text-secondary);">Track your musical journey</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Dark Mode Toggle -->
                    <button id="darkModeToggle" class="p-3 rounded-xl transition-all hover:scale-110" style="background: var(--bg-secondary); border: 1px solid var(--border-color);" aria-label="Toggle dark mode">
                        <i data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                    <!-- Settings Button -->
                    <button id="settingsBtn" class="p-3 rounded-xl transition-all hover:scale-110" style="background: var(--bg-secondary); border: 1px solid var(--border-color);" aria-label="Open settings">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <nav class="flex gap-2 overflow-x-auto pb-2" id="navTabs" role="tablist" aria-label="Main navigation">
                <button class="tab active" data-view="tracker" role="tab" aria-selected="true" aria-controls="trackerView">
                    <i data-lucide="calendar-check" class="w-4 h-4 inline mr-2"></i>Tracker
                </button>
                <button class="tab" data-view="statistics" role="tab" aria-selected="false" aria-controls="statisticsView">
                    <i data-lucide="bar-chart-3" class="w-4 h-4 inline mr-2"></i>Statistics
                </button>
                <button class="tab" data-view="heatmap" role="tab" aria-selected="false" aria-controls="heatmapView">
                    <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>Calendar
                </button>
                <button class="tab" data-view="export" role="tab" aria-selected="false" aria-controls="exportView">
                    <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>Export
                </button>
            </nav>
        </header>

        <!-- Tracker View -->
        <div id="trackerView" class="view-content" role="tabpanel" aria-labelledby="tracker-tab">
            <!-- Week Navigation -->
            <div class="glass rounded-2xl p-6 mb-6 animate-slide-in-up" style="animation-delay: 0.1s;">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <button id="prevWeek" class="btn btn-secondary p-3 rounded-xl" aria-label="Previous week">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div class="text-center">
                            <input type="date" id="weekDate" class="text-lg font-semibold px-4 py-2 rounded-lg border-2 transition-all" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" aria-label="Select week">
                            <div id="weekRange" class="text-sm mt-1" style="color: var(--text-secondary);" aria-live="polite"></div>
                        </div>
                        <button id="nextWeek" class="btn btn-secondary p-3 rounded-xl" aria-label="Next week">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="flex flex-col items-center gap-2">
                        <button id="authBtn" class="btn btn-primary" disabled>
                            <i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>
                            Loading...
                        </button>
                        <div id="syncStatus" class="text-xs" style="color: var(--text-tertiary);"></div>
                    </div>
                </div>
            </div>

            <!-- Practice Grid -->
            <div class="grid gap-6 mb-6">
                <div class="glass rounded-2xl p-6 animate-slide-in-up" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="target" class="w-5 h-5"></i>
                        Weekly Practice
                    </h2>
                    <div id="practiceGrid" class="space-y-4"></div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Weekly Progress -->
                <div class="glass rounded-2xl p-6 animate-slide-in-up" style="animation-delay: 0.3s;">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                        Weekly Progress
                    </h3>
                    <div id="weeklyProgress" class="space-y-3"></div>
                </div>

                <!-- Streak Section -->
                <div class="gradient-bg rounded-2xl p-6 text-white animate-slide-in-up" style="animation-delay: 0.4s;">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="flame" class="w-5 h-5"></i>
                        Current Streak
                    </h3>
                    <div class="flex items-center justify-center gap-6">
                        <div class="text-6xl" style="animation: flicker 2s ease-in-out infinite;">üî•</div>
                        <div class="text-center">
                            <div id="streakNumber" class="text-5xl font-bold">0</div>
                            <div class="text-sm opacity-90">weeks</div>
                        </div>
                    </div>
                    <div id="streakDescription" class="text-center text-sm mt-4 opacity-90"></div>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="glass rounded-2xl p-6 animate-slide-in-up" style="animation-delay: 0.5s;">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="sticky-note" class="w-5 h-5"></i>
                    Week Notes
                </h3>
                <textarea id="weekNotes" placeholder="Add notes about this week's practice..." class="w-full p-4 rounded-lg border-2 min-h-[100px] resize-none transition-all" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"></textarea>
                <div class="flex gap-2 mt-3">
                    <button id="saveNotesBtn" class="btn btn-success">
                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>Save Notes
                    </button>
                    <button id="undoBtn" class="btn btn-secondary" disabled>
                        <i data-lucide="undo" class="w-4 h-4 inline mr-2"></i>Undo
                    </button>
                    <button id="redoBtn" class="btn btn-secondary" disabled>
                        <i data-lucide="redo" class="w-4 h-4 inline mr-2"></i>Redo
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics View -->
        <div id="statisticsView" class="view-content hidden" role="tabpanel" aria-labelledby="statistics-tab">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Progress Chart -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="line-chart" class="w-5 h-5"></i>
                        Progress Over Time
                    </h3>
                    <canvas id="progressChart"></canvas>
                </div>

                <!-- Instrument Distribution -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-5 h-5"></i>
                        Practice Distribution
                    </h3>
                    <canvas id="distributionChart"></canvas>
                </div>

                <!-- Stats Cards -->
                <div class="lg:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="stat-card">
                        <div class="text-3xl mb-2">üìä</div>
                        <div class="text-2xl font-bold" id="totalPractices">0</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Total Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl mb-2">üéØ</div>
                        <div class="text-2xl font-bold" id="completedWeeks">0</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Completed Weeks</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl mb-2">‚≠ê</div>
                        <div class="text-2xl font-bold" id="longestStreak">0</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Longest Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl mb-2">üé∏</div>
                        <div class="text-2xl font-bold" id="favoriteInstrument">-</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Most Practiced</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Heatmap View -->
        <div id="heatmapView" class="view-content hidden" role="tabpanel" aria-labelledby="heatmap-tab">
            <div class="glass rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    Practice Calendar
                </h3>
                <div id="heatmapContainer" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- Export View -->
        <div id="exportView" class="view-content hidden" role="tabpanel" aria-labelledby="export-tab">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stat-card cursor-pointer hover:shadow-lg" onclick="exportData('csv')">
                    <div class="text-4xl mb-3">üìä</div>
                    <h3 class="text-lg font-bold mb-2">Export CSV</h3>
                    <p class="text-sm" style="color: var(--text-secondary);">Download practice data as CSV</p>
                </div>
                <div class="stat-card cursor-pointer hover:shadow-lg" onclick="exportData('json')">
                    <div class="text-4xl mb-3">üìÑ</div>
                    <h3 class="text-lg font-bold mb-2">Export JSON</h3>
                    <p class="text-sm" style="color: var(--text-secondary);">Download raw data backup</p>
                </div>
                <div class="stat-card cursor-pointer hover:shadow-lg" onclick="exportData('pdf')">
                    <div class="text-4xl mb-3">üìë</div>
                    <h3 class="text-lg font-bold mb-2">Export PDF</h3>
                    <p class="text-sm" style="color: var(--text-secondary);">Generate practice report</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden" role="dialog" aria-labelledby="settings-title" aria-modal="true">
        <div class="modal-content w-full md:w-[600px] p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 id="settings-title" class="text-2xl font-bold flex items-center gap-2">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                    Settings
                </h2>
                <button id="closeSettings" class="p-2 rounded-lg hover:bg-gray-100 transition-all" aria-label="Close settings">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Instruments -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Instruments</h3>
                    <div id="instrumentsList" class="space-y-2"></div>
                    <button id="addInstrumentBtn" class="btn btn-secondary mt-3 w-full">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>Add Instrument
                    </button>
                </div>

                <!-- Goals -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Weekly Goal</h3>
                    <div class="flex items-center gap-4">
                        <label class="flex-1" style="color: var(--text-secondary);">Days per week per instrument:</label>
                        <input type="number" id="weeklyGoal" min="1" max="7" value="3" class="w-20 px-3 py-2 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                    </div>
                </div>

                <!-- Theme Colors -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Theme</h3>
                    <div class="grid grid-cols-4 gap-3">
                        <button class="theme-color w-full h-12 rounded-lg" style="background: linear-gradient(135deg, #667eea, #764ba2);" data-theme="purple"></button>
                        <button class="theme-color w-full h-12 rounded-lg" style="background: linear-gradient(135deg, #f093fb, #f5576c);" data-theme="pink"></button>
                        <button class="theme-color w-full h-12 rounded-lg" style="background: linear-gradient(135deg, #4facfe, #00f2fe);" data-theme="blue"></button>
                        <button class="theme-color w-full h-12 rounded-lg" style="background: linear-gradient(135deg, #43e97b, #38f9d7);" data-theme="green"></button>
                    </div>
                </div>

                <!-- Reset -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-red-500">Danger Zone</h3>
                    <button id="resetAllBtn" class="btn w-full" style="background: var(--danger); color: white;">
                        <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google APIs - Load scripts first, define callbacks in main script -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Google Drive Config
        const CLIENT_ID = '90415557909-pgkuol7snj6s4o4tqrk2p0f8oginu53s.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA82u5qKmYkXl5cdBoYvQEizzdkgsi_ZR4';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'music_practice_data.json';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let fileId = null;
        let scriptLoadTimeout = null;

        // App State
        let allWeeksData = loadAllWeeksData();
        // Ensure weeks object always exists
        if (!allWeeksData.weeks) {
            allWeeksData.weeks = {};
            saveAllWeeksData();
        }
        let practiceData = {};
        
        // Backup local data before any Drive operations to prevent data loss
        function backupLocalData() {
            const backup = JSON.stringify(allWeeksData);
            localStorage.setItem('musicPractice_backup', backup);
            console.log('Local data backed up');
        }
        
        function restoreLocalData() {
            const backup = localStorage.getItem('musicPractice_backup');
            if (backup) {
                try {
                    const backupData = JSON.parse(backup);
                    if (backupData.weeks && Object.keys(backupData.weeks).length > 0) {
                        console.log('Restoring from backup');
                        allWeeksData = backupData;
                        saveAllWeeksData();
                        return true;
                    }
                } catch (e) {
                    console.error('Error restoring backup:', e);
                }
            }
            return false;
        }
        
        // Create backup on load
        if (Object.keys(allWeeksData.weeks || {}).length > 0) {
            backupLocalData();
        }
        let streakData = loadStreakData();
        let settings = loadSettings();
        let undoStack = [];
        let redoStack = [];
        let charts = {};

        // Default settings
        function getDefaultSettings() {
            return {
                instruments: [
                    { id: 'electric', name: 'Electric Guitar', icon: 'üé∏', color: '#f59e0b' },
                    { id: 'classical', name: 'Classical Guitar', icon: 'üéª', color: '#3b82f6' },
                    { id: 'bass', name: 'Bass', icon: 'üé∏', color: '#8b5cf6' },
                    { id: 'piano', name: 'Piano', icon: 'üéπ', color: '#ec4899' }
                ],
                weeklyGoal: 3,
                theme: 'purple'
            };
        }

        function loadSettings() {
            const saved = localStorage.getItem('appSettings');
            if (saved) {
                return JSON.parse(saved);
            }
            return getDefaultSettings();
        }

        function saveSettings() {
            localStorage.setItem('appSettings', JSON.stringify(settings));
        }

        // Dark mode
        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                const icon = document.querySelector('#darkModeToggle i');
                icon.setAttribute('data-lucide', 'sun');
                lucide.createIcons();
            }
        }

        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            const icon = document.querySelector('#darkModeToggle i');
            icon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            lucide.createIcons();
        });

        // Navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const view = tab.dataset.view;
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                document.getElementById(view + 'View').classList.remove('hidden');

                if (view === 'statistics') {
                    renderStatistics();
                } else if (view === 'heatmap') {
                    renderHeatmap();
                }
            });
        });

        // Settings Modal
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('hidden');
            renderSettings();
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('hidden');
        });

        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') {
                document.getElementById('settingsModal').classList.add('hidden');
            }
        });

        function renderSettings() {
            // Render instruments list
            const instrumentsList = document.getElementById('instrumentsList');
            instrumentsList.innerHTML = settings.instruments.map((inst, idx) => `
                <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                    <span class="text-2xl">${inst.icon}</span>
                    <input type="text" value="${inst.name}" class="flex-1 px-3 py-2 rounded-lg border" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" onchange="updateInstrument(${idx}, this.value)">
                    <button class="p-2 rounded-lg hover:bg-red-100 transition-all" onclick="removeInstrument(${idx})">
                        <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();

            // Set weekly goal
            document.getElementById('weeklyGoal').value = settings.weeklyGoal;
        }

        function updateInstrument(idx, name) {
            settings.instruments[idx].name = name;
            saveSettings();
            renderPracticeGrid();
        }

        function removeInstrument(idx) {
            if (settings.instruments.length <= 1) {
                showToast('You need at least one instrument!', 'error');
                return;
            }
            if (confirm('Remove this instrument? All practice data for it will be lost.')) {
                settings.instruments.splice(idx, 1);
                saveSettings();
                renderSettings();
                renderPracticeGrid();
            }
        }

        document.getElementById('addInstrumentBtn').addEventListener('click', () => {
            const name = prompt('Enter instrument name:');
            if (name) {
                const id = name.toLowerCase().replace(/\s+/g, '-');
                settings.instruments.push({
                    id: id,
                    name: name,
                    icon: 'üéµ',
                    color: '#' + Math.floor(Math.random()*16777215).toString(16)
                });
                saveSettings();
                renderSettings();
                renderPracticeGrid();
            }
        });

        document.getElementById('weeklyGoal').addEventListener('change', (e) => {
            settings.weeklyGoal = parseInt(e.target.value);
            saveSettings();
            updateSummary();
        });

        document.getElementById('resetAllBtn').addEventListener('click', () => {
            if (confirm('Are you sure? This will delete ALL practice data and cannot be undone!')) {
                if (confirm('Really? This action is permanent!')) {
                    // Clear only practice data, NOT sign-in state or settings
                    localStorage.removeItem('musicPractice');
                    localStorage.removeItem('streakData');
                    localStorage.removeItem('appSettings');
                    // Keep googleSignedIn and googleUserEmail so user stays logged in
                    location.reload();
                }
            }
        });

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}" class="w-5 h-5"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Date utilities
        function setDateInputValue(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getWeekKey() {
            const date = new Date(document.getElementById('weekDate').value + 'T00:00:00');
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${String(weekNum).padStart(2, '0')}`;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updateWeekRangeDisplay() {
            const date = new Date(document.getElementById('weekDate').value + 'T00:00:00');
            const dayOfWeek = date.getDay();
            const monday = new Date(date);
            monday.setDate(date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            const formatDate = (d) => {
                const month = d.toLocaleDateString('en-US', { month: 'short' });
                const day = d.getDate();
                return `${month} ${day}`;
            };

            document.getElementById('weekRange').textContent = `${formatDate(monday)} - ${formatDate(sunday)}`;
        }

        // Data management
        function loadAllWeeksData() {
            const saved = localStorage.getItem('musicPractice');
            if (saved) {
                const data = JSON.parse(saved);
                if (!data.weeks) {
                    const weekKey = getWeekKey();
                    return { weeks: { [weekKey]: data } };
                }
                return data;
            }
            return { weeks: {} };
        }

        function saveAllWeeksData() {
            localStorage.setItem('musicPractice', JSON.stringify(allWeeksData));
        }

        function loadWeekData() {
            const weekKey = getWeekKey();
            // Safety check - ensure weeks object exists
            if (!allWeeksData.weeks) {
                allWeeksData.weeks = {};
            }
            practiceData = allWeeksData.weeks[weekKey] || {};

            // Load notes
            const notes = practiceData._notes || '';
            document.getElementById('weekNotes').value = notes;
        }

        function saveWeekData() {
            const weekKey = getWeekKey();
            allWeeksData.weeks[weekKey] = practiceData;
            saveAllWeeksData();
            // Update backup whenever data changes
            backupLocalData();
        }

        function loadStreakData() {
            const saved = localStorage.getItem('streakData');
            if (saved) {
                return JSON.parse(saved);
            }
            return { completedWeeks: [], currentStreak: 0, longestStreak: 0 };
        }

        function saveStreakData() {
            localStorage.setItem('streakData', JSON.stringify(streakData));
        }

        // Undo/Redo
        function saveState() {
            undoStack.push(JSON.parse(JSON.stringify(practiceData)));
            redoStack = [];
            if (undoStack.length > 50) undoStack.shift();
            updateUndoRedoButtons();
        }

        function undo() {
            if (undoStack.length > 0) {
                redoStack.push(JSON.parse(JSON.stringify(practiceData)));
                practiceData = undoStack.pop();
                saveWeekData();
                renderPracticeGrid();
                updateSummary();
                updateUndoRedoButtons();
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                undoStack.push(JSON.parse(JSON.stringify(practiceData)));
                practiceData = redoStack.pop();
                saveWeekData();
                renderPracticeGrid();
                updateSummary();
                updateUndoRedoButtons();
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = undoStack.length === 0;
            document.getElementById('redoBtn').disabled = redoStack.length === 0;
        }

        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);

        // Practice Grid
        function renderPracticeGrid() {
            const grid = document.getElementById('practiceGrid');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            grid.innerHTML = settings.instruments.map(instrument => `
                <div class="mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="instrument-icon" style="background: ${instrument.color}20; color: ${instrument.color};">
                            ${instrument.icon}
                        </div>
                        <span class="font-semibold text-lg">${instrument.name}</span>
                    </div>
                    <div class="grid grid-cols-7 gap-2">
                        ${days.map((day, idx) => {
                            const key = `${instrument.id}-${idx}`;
                            const checked = practiceData[key] || false;
                            return `
                                <div class="text-center">
                                    <div class="text-xs mb-1" style="color: var(--text-secondary);">${day}</div>
                                    <div class="check-cell ${checked ? 'checked' : ''}"
                                         data-instrument="${instrument.id}"
                                         data-day="${idx}">
                                        ${checked ? '‚úì' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.check-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    saveState();
                    const instrument = this.dataset.instrument;
                    const day = this.dataset.day;
                    const key = `${instrument}-${day}`;

                    const wasChecked = this.classList.contains('checked');
                    this.classList.toggle('checked');

                    if (this.classList.contains('checked')) {
                        this.textContent = '‚úì';
                        practiceData[key] = true;
                        playCheckSound();
                        this.classList.add('just-checked');
                        setTimeout(() => this.classList.remove('just-checked'), 400);
                    } else {
                        this.textContent = '';
                        delete practiceData[key];
                        playUncheckSound();
                    }

                    saveWeekData();
                    updateSummary();

                    if (accessToken) {
                        syncData();
                    }
                });
            });
        }

        // Summary
        function updateSummary() {
            const progressDiv = document.getElementById('weeklyProgress');

            progressDiv.innerHTML = settings.instruments.map(instrument => {
                let count = 0;
                for (let day = 0; day < 7; day++) {
                    const key = `${instrument.id}-${day}`;
                    if (practiceData[key]) count++;
                }

                const percentage = (count / settings.weeklyGoal) * 100;
                const goalMet = count >= settings.weeklyGoal;

                return `
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="flex items-center gap-2">
                                <span>${instrument.icon}</span>
                                <span class="font-medium">${instrument.name}</span>
                            </span>
                            <span class="font-bold ${goalMet ? 'text-green-500' : 'text-gray-400'}">
                                ${count} / ${settings.weeklyGoal}
                            </span>
                        </div>
                        <div class="w-full h-2 rounded-full" style="background: var(--bg-tertiary);">
                            <div class="h-full rounded-full transition-all duration-500"
                                 style="width: ${Math.min(percentage, 100)}%; background: ${goalMet ? 'linear-gradient(90deg, #10b981, #059669)' : 'linear-gradient(90deg, #f59e0b, #d97706)'};"></div>
                        </div>
                    </div>
                `;
            }).join('');

            checkWeekCompletion();
        }

        // Streak
        function checkWeekCompletion() {
            let allGoalsMet = true;

            settings.instruments.forEach(instrument => {
                let count = 0;
                for (let day = 0; day < 7; day++) {
                    const key = `${instrument.id}-${day}`;
                    if (practiceData[key]) count++;
                }
                if (count < settings.weeklyGoal) allGoalsMet = false;
            });

            const weekKey = getWeekKey();
            const wasCompleted = streakData.completedWeeks.includes(weekKey);

            if (allGoalsMet && !wasCompleted) {
                streakData.completedWeeks.push(weekKey);
                updateStreak();
                saveStreakData();

                setTimeout(() => {
                    playCelebrationSound();
                    createConfetti();
                    showStreakAchievement();
                }, 500);
            } else if (!allGoalsMet && wasCompleted) {
                streakData.completedWeeks = streakData.completedWeeks.filter(w => w !== weekKey);
                updateStreak();
                saveStreakData();
            }

            updateStreakDisplay();
        }

        function updateStreak() {
            const sorted = streakData.completedWeeks.sort();

            if (sorted.length === 0) {
                streakData.currentStreak = 0;
                return;
            }

            let streak = 1;
            for (let i = sorted.length - 1; i > 0; i--) {
                const current = parseWeekKey(sorted[i]);
                const prev = parseWeekKey(sorted[i - 1]);

                if (current.week - prev.week === 1 || (current.week === 1 && prev.week >= 52)) {
                    streak++;
                } else {
                    break;
                }
            }

            streakData.currentStreak = streak;
            if (streak > streakData.longestStreak) {
                streakData.longestStreak = streak;
            }
        }

        function parseWeekKey(weekKey) {
            const [year, week] = weekKey.split('-W');
            return { year: parseInt(year), week: parseInt(week) };
        }

        function updateStreakDisplay() {
            document.getElementById('streakNumber').textContent = streakData.currentStreak;

            const desc = document.getElementById('streakDescription');
            if (streakData.currentStreak === 0) {
                desc.textContent = 'Complete all goals to start your streak!';
            } else if (streakData.currentStreak === 1) {
                desc.textContent = 'üéâ Great start! Keep going!';
            } else if (streakData.currentStreak < 4) {
                desc.textContent = `üí™ ${streakData.currentStreak} weeks strong!`;
            } else if (streakData.currentStreak < 10) {
                desc.textContent = `üî• ${streakData.currentStreak} weeks in a row!`;
            } else {
                desc.textContent = `‚≠ê LEGENDARY! ${streakData.currentStreak} weeks!`;
            }
        }

        function showStreakAchievement() {
            const achievement = document.createElement('div');
            achievement.className = 'modal';
            achievement.innerHTML = `
                <div class="modal-content w-full md:w-[500px] p-12 text-center gradient-pink text-white">
                    <div class="text-8xl mb-4" style="animation: celebration 0.6s ease;">üî•</div>
                    <div class="text-4xl font-bold mb-2">${streakData.currentStreak} WEEK STREAK!</div>
                    <div class="text-lg opacity-90">All goals completed! Keep it up!</div>
                </div>
            `;
            document.body.appendChild(achievement);

            setTimeout(() => {
                achievement.style.opacity = '0';
                setTimeout(() => achievement.remove(), 300);
            }, 3000);
        }

        // Sound effects
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playCheckSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playUncheckSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 400;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playCelebrationSound() {
            const notes = [523, 659, 784, 1047];
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = freq;
                oscillator.type = 'triangle';
                const startTime = audioContext.currentTime + (index * 0.1);
                gainNode.gain.setValueAtTime(0.2, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.2);
            });
        }

        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.top = '-10px';
                confetti.style.opacity = '1';
                confetti.style.pointerEvents = 'none';
                confetti.style.zIndex = '9999';
                confetti.style.borderRadius = '50%';

                document.body.appendChild(confetti);

                const duration = Math.random() * 3 + 2;
                const rotation = Math.random() * 360;
                const xOffset = (Math.random() - 0.5) * 200;

                confetti.animate([
                    { transform: `translateY(0) translateX(0) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(${window.innerHeight + 10}px) translateX(${xOffset}px) rotate(${rotation}deg)`, opacity: 0 }
                ], {
                    duration: duration * 1000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                });

                setTimeout(() => confetti.remove(), duration * 1000);
            }
        }

        // Week navigation
        document.getElementById('prevWeek').addEventListener('click', () => {
            const dateInput = document.getElementById('weekDate');
            const currentDate = new Date(dateInput.value + 'T00:00:00');
            currentDate.setDate(currentDate.getDate() - 7);
            dateInput.value = setDateInputValue(currentDate);
            updateWeekDisplay();
        });

        document.getElementById('nextWeek').addEventListener('click', () => {
            const dateInput = document.getElementById('weekDate');
            const currentDate = new Date(dateInput.value + 'T00:00:00');
            currentDate.setDate(currentDate.getDate() + 7);
            dateInput.value = setDateInputValue(currentDate);
            updateWeekDisplay();
        });

        document.getElementById('weekDate').addEventListener('change', updateWeekDisplay);

        function updateWeekDisplay() {
            loadWeekData();
            renderPracticeGrid();
            updateSummary();
            updateWeekRangeDisplay();
        }

        // Notes
        document.getElementById('saveNotesBtn').addEventListener('click', () => {
            const notes = document.getElementById('weekNotes').value;
            practiceData._notes = notes;
            saveWeekData();
            showToast('Notes saved!', 'success');

            if (accessToken) {
                syncData();
            }
        });

        // Statistics
        function renderStatistics() {
            // Calculate stats
            let totalPractices = 0;
            const instrumentCounts = {};

            settings.instruments.forEach(inst => {
                instrumentCounts[inst.name] = 0;
            });

            Object.keys(allWeeksData.weeks).forEach(weekKey => {
                const weekData = allWeeksData.weeks[weekKey];
                Object.keys(weekData).forEach(key => {
                    if (!key.startsWith('_') && weekData[key]) {
                        totalPractices++;
                        const instrumentId = key.split('-')[0];
                        const instrument = settings.instruments.find(i => i.id === instrumentId);
                        if (instrument) {
                            instrumentCounts[instrument.name]++;
                        }
                    }
                });
            });

            document.getElementById('totalPractices').textContent = totalPractices;
            document.getElementById('completedWeeks').textContent = streakData.completedWeeks.length;
            document.getElementById('longestStreak').textContent = streakData.longestStreak;

            const favorite = Object.keys(instrumentCounts).reduce((a, b) =>
                instrumentCounts[a] > instrumentCounts[b] ? a : b, '-');
            document.getElementById('favoriteInstrument').textContent = favorite !== '-' ? favorite.split(' ')[0] : '-';

            // Progress chart
            const progressCtx = document.getElementById('progressChart');
            if (charts.progress) charts.progress.destroy();

            const weeks = Object.keys(allWeeksData.weeks).sort().slice(-12);
            const weeklyTotals = weeks.map(weekKey => {
                const weekData = allWeeksData.weeks[weekKey];
                return Object.keys(weekData).filter(k => !k.startsWith('_') && weekData[k]).length;
            });

            charts.progress = new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: weeks.map(w => w.replace(/^\d+-W/, 'W')),
                    datasets: [{
                        label: 'Practice Sessions',
                        data: weeklyTotals,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Distribution chart
            const distributionCtx = document.getElementById('distributionChart');
            if (charts.distribution) charts.distribution.destroy();

            charts.distribution = new Chart(distributionCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(instrumentCounts),
                    datasets: [{
                        data: Object.values(instrumentCounts),
                        backgroundColor: settings.instruments.map(i => i.color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Heatmap
        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 364); // 52 weeks

            const weeks = [];
            for (let i = 0; i < 52; i++) {
                const week = [];
                for (let j = 0; j < 7; j++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i * 7 + j);

                    const dateKey = setDateInputValue(date);
                    const weekKey = getWeekKeyForDate(date);
                    const weekData = allWeeksData.weeks[weekKey] || {};

                    let count = 0;
                    Object.keys(weekData).forEach(key => {
                        if (!key.startsWith('_') && weekData[key]) count++;
                    });

                    const level = count === 0 ? 0 : count < 5 ? 1 : count < 10 ? 2 : count < 15 ? 3 : 4;
                    week.push({ date, count, level });
                }
                weeks.push(week);
            }

            container.innerHTML = `
                <div class="flex gap-1">
                    ${weeks.map(week => `
                        <div class="flex flex-col gap-1">
                            ${week.map(day => `
                                <div class="heatmap-day level-${day.level}"
                                     title="${day.date.toLocaleDateString()}: ${day.count} practices">
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
                <div class="flex items-center gap-2 mt-4 text-sm" style="color: var(--text-secondary);">
                    <span>Less</span>
                    <div class="heatmap-day level-0"></div>
                    <div class="heatmap-day level-1"></div>
                    <div class="heatmap-day level-2"></div>
                    <div class="heatmap-day level-3"></div>
                    <div class="heatmap-day level-4"></div>
                    <span>More</span>
                </div>
            `;
        }

        function getWeekKeyForDate(date) {
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${String(weekNum).padStart(2, '0')}`;
        }

        // Export
        function exportData(format) {
            if (format === 'csv') {
                let csv = 'Week,Instrument,Mon,Tue,Wed,Thu,Fri,Sat,Sun,Total\n';
                Object.keys(allWeeksData.weeks).sort().forEach(weekKey => {
                    const weekData = allWeeksData.weeks[weekKey];
                    settings.instruments.forEach(inst => {
                        const days = [];
                        let total = 0;
                        for (let i = 0; i < 7; i++) {
                            const checked = weekData[`${inst.id}-${i}`] ? 1 : 0;
                            days.push(checked);
                            total += checked;
                        }
                        csv += `${weekKey},${inst.name},${days.join(',')},${total}\n`;
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                downloadFile(blob, 'practice-data.csv');
                showToast('CSV exported!', 'success');
            } else if (format === 'json') {
                const json = JSON.stringify(allWeeksData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                downloadFile(blob, 'practice-data.json');
                showToast('JSON exported!', 'success');
            } else if (format === 'pdf') {
                showToast('PDF export coming soon!', 'info');
            }
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Google Drive integration - functions moved to top before script tags
        // Google API initialization callbacks
        function gapiLoaded() {
            try {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: API_KEY,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                        });
                        gapiInited = true;
                        console.log('GAPI initialized');
                        updateAuthButton();
                    } catch (err) {
                        console.error('Error initializing GAPI:', err);
                        gapiInited = true; // Mark as initialized even on error to enable button
                        showToast('Error loading Google APIs', 'error');
                        updateAuthButton(); // Still try to enable button
                    }
                });
            } catch (err) {
                console.error('Error loading GAPI client:', err);
                gapiInited = true; // Mark as initialized even on error to enable button
                showToast('Error loading Google APIs', 'error');
                updateAuthButton(); // Still try to enable button
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '',
                });
                gisInited = true;
                console.log('GIS initialized');
                updateAuthButton();
            } catch (err) {
                console.error('Error initializing GIS:', err);
                gisInited = true; // Mark as initialized even on error to enable button
                showToast('Error loading Google OAuth', 'error');
                updateAuthButton(); // Still try to enable button
            }
        }

        function updateAuthButton() {
            const btn = document.getElementById('authBtn');
            if (!btn) {
                console.error('Auth button not found!');
                return;
            }

            if (gapiInited && gisInited) {
                // Check if there's an existing valid token in current session
                try {
                    if (!gapi.client || typeof gapi.client.getToken !== 'function') {
                        throw new Error('gapi.client not available');
                    }
                    const token = gapi.client.getToken();
                    if (token !== null && token.access_token) {
                        accessToken = token.access_token;
                        updateSignedInUI();
                        loadFromDrive();
                        return;
                    }
                } catch (err) {
                    console.error('Error checking token:', err);
                }

                // Check localStorage for saved sign-in state - auto-restore session
                const wasSignedIn = localStorage.getItem('googleSignedIn') === 'true';
                const savedEmail = localStorage.getItem('googleUserEmail');
                
                // Always render local data first so user sees something
                loadWeekData();
                renderPracticeGrid();
                
                if (wasSignedIn && savedEmail && tokenClient && typeof tokenClient.requestAccessToken === 'function') {
                    console.log('Restoring session - attempting silent sign-in with hint:', savedEmail);
                    attemptSilentSignIn(savedEmail);
                } else {
                    // No saved session or tokenClient not ready, show sign-in button
                    console.log('No saved session or tokenClient not ready, showing sign-in button');
                    btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                    btn.disabled = false;
                    lucide.createIcons();
                    // Render local data so user sees something immediately
                    loadWeekData();
                    renderPracticeGrid();
                }
            } else {
                // Scripts not loaded yet, set a timeout to enable button anyway (only once)
                if (!scriptLoadTimeout) {
                    scriptLoadTimeout = setTimeout(() => {
                        if (!gapiInited || !gisInited) {
                            console.warn('APIs failed to load - enabling button anyway');
                            const btn = document.getElementById('authBtn');
                            if (btn) {
                                btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                                btn.disabled = false;
                                lucide.createIcons();
                                showToast('Google APIs not available - using local storage only', 'error');
                                loadWeekData();
                                renderPracticeGrid();
                            }
                        }
                    }, 5000); // 5 second timeout for scripts to load
                }
            }
        }

        function attemptSilentSignIn(email) {
            // Safety check - if tokenClient doesn't exist or is invalid, just enable button
            if (!tokenClient) {
                console.log('tokenClient not available - enabling sign-in button');
                const btn = document.getElementById('authBtn');
                btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                btn.disabled = false;
                lucide.createIcons();
                loadWeekData();
                renderPracticeGrid();
                return;
            }

            let callbackFired = false;
            const timeout = setTimeout(() => {
                if (!callbackFired) {
                    console.log('Silent sign-in timeout - enabling sign-in button');
                    callbackFired = true;
                    const btn = document.getElementById('authBtn');
                    btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                    btn.disabled = false;
                    lucide.createIcons();
                    // Also render local data so user sees something
                    loadWeekData();
                    renderPracticeGrid();
                }
            }, 3000); // 3 second timeout

            tokenClient.callback = async (resp) => {
                if (callbackFired) return; // Already handled by timeout
                callbackFired = true;
                clearTimeout(timeout);

                if (resp.error !== undefined) {
                    console.log('Silent sign-in failed:', resp.error);
                    const btn = document.getElementById('authBtn');
                    btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                    btn.disabled = false;
                    lucide.createIcons();
                    // Render local data so user sees something
                    loadWeekData();
                    renderPracticeGrid();
                    return;
                }

                console.log('Silent sign-in successful');
                accessToken = gapi.client.getToken().access_token;
                // Persist sign-in state
                localStorage.setItem('googleSignedIn', 'true');
                updateSignedInUI();
                
                // Render local data immediately so table isn't blank while Drive loads
                loadWeekData();
                renderPracticeGrid();
                
                await loadFromDrive();
            };

            try {
                tokenClient.requestAccessToken({prompt: '', login_hint: email});
            } catch (err) {
                console.error('Error requesting access token:', err);
                clearTimeout(timeout);
                callbackFired = true;
                const btn = document.getElementById('authBtn');
                btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                btn.disabled = false;
                lucide.createIcons();
                loadWeekData();
                renderPracticeGrid();
            }
        }

        function updateSignedInUI() {
            const btn = document.getElementById('authBtn');
            btn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>Signed in';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            btn.disabled = true;
            lucide.createIcons();
            showStatus('Auto-sync enabled', 'success');
        }

        function handleAuth() {
            if (!gapiInited || !gisInited || !tokenClient) {
                showToast('Google APIs not ready - please refresh', 'error');
                // Re-enable button so user can try again
                const btn = document.getElementById('authBtn');
                btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                btn.disabled = false;
                lucide.createIcons();
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Auth error:', resp.error);
                    showToast('Auth failed - please try again', 'error');
                    // Re-enable button so user can try again
                    const btn = document.getElementById('authBtn');
                    btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                    btn.disabled = false;
                    btn.classList.remove('btn-success');
                    lucide.createIcons();
                    return;
                }

                try {
                    accessToken = gapi.client.getToken().access_token;
                    localStorage.setItem('googleSignedIn', 'true');

                    try {
                        const userInfo = await gapi.client.drive.about.get({fields: 'user'});
                        const email = userInfo.result.user.emailAddress;
                        localStorage.setItem('googleUserEmail', email);
                    } catch (err) {
                        console.error('Could not get user email:', err);
                    }

                    updateSignedInUI();
                    
                    // Render local data immediately so table isn't blank while Drive loads
                    loadWeekData();
                    renderPracticeGrid();

                    // Try to load from Drive, but don't show errors if it fails
                    try {
                        await loadFromDrive();
                    } catch (err) {
                        // Silently handle Drive errors - user is signed in and local data is shown
                        console.log('Drive sync will happen in background:', err);
                        // Sync local data to Drive in background
                        if (accessToken) {
                            setTimeout(() => {
                                syncData().catch(() => {}); // Silent fail
                            }, 2000);
                        }
                    }
                } catch (err) {
                    console.error('Error after auth:', err);
                    // Still show signed in but render local data
                    updateSignedInUI();
                    loadWeekData();
                    renderPracticeGrid();
                    // Show success, not error
                    showStatus('Signed in - local data saved', 'success');
                }
            };

            try {
                if (gapi.client && gapi.client.getToken && gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            } catch (err) {
                console.error('Error requesting access token:', err);
                showToast('Error starting sign-in - please try again', 'error');
                const btn = document.getElementById('authBtn');
                btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        document.getElementById('authBtn').addEventListener('click', handleAuth);

        async function findOrCreateFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                const fileMetadata = {
                    name: FILE_NAME,
                    mimeType: 'application/json'
                };

                const createResponse = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });

                return createResponse.result.id;
            } catch (err) {
                console.error('Error finding/creating file:', err);
                // Don't show error toast - just return null silently
                return null;
            }
        }

        async function loadFromDrive() {
            // Don't show loading status if user is already signed in and data is visible
            const isSilentLoad = accessToken && Object.keys(allWeeksData.weeks || {}).length > 0;
            if (!isSilentLoad) {
                showStatus('Loading from Drive...', 'loading');
            }

            try {
                // Check if gapi.client is ready
                if (!gapi.client || !gapi.client.drive) {
                    console.log('GAPI client not ready yet, skipping Drive load');
                    return;
                }

                fileId = await findOrCreateFile();
                if (!fileId) {
                    // Could not create file, render local data instead
                    loadWeekData();
                    renderPracticeGrid();
                    updateSummary();
                    if (!isSilentLoad) {
                        showStatus('Signed in', 'success');
                    }
                    return;
                }

                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });

                if (response.body) {
                    const driveData = JSON.parse(response.body);
                    // MERGE Drive data with local data - ONLY if Drive has actual content
                    if (driveData.weeks && Object.keys(driveData.weeks).length > 0) {
                        // Backup before merge
                        backupLocalData();
                        
                        // Drive has data - merge it with local, but preserve local weeks not in Drive
                        const localWeeks = allWeeksData.weeks || {};
                        const driveWeeks = driveData.weeks || {};
                        
                        // Only merge if Drive has actual practice data (not just empty week objects)
                        const driveHasData = Object.values(driveWeeks).some(week => 
                            week && typeof week === 'object' && Object.keys(week).length > 0
                        );
                        
                        if (driveHasData) {
                            // Merge: Drive overwrites matching weeks, but local weeks not in Drive are preserved
                            const mergedWeeks = Object.assign({}, localWeeks, driveWeeks);
                            allWeeksData = { weeks: mergedWeeks };
                            saveAllWeeksData(); // Save merged data
                            console.log('Merged Drive data with local data');
                        } else {
                            // Drive has structure but no actual data - keep local data
                            console.log('Drive has structure but no data, keeping local data intact');
                            // Don't change allWeeksData - keep what we have locally
                        }
                    } else {
                        // Drive is empty or has no weeks - KEEP LOCAL DATA, don't overwrite
                        console.log('Drive has no data, keeping local data intact');
                        // Don't change allWeeksData - keep what we have locally
                        // Sync local data TO Drive instead
                        if (Object.keys(allWeeksData.weeks || {}).length > 0) {
                            console.log('Syncing local data to Drive...');
                            setTimeout(() => syncData(), 1000);
                        }
                    }
                    
                    // Safety check: if local data is now empty, restore from backup
                    if (Object.keys(allWeeksData.weeks || {}).length === 0) {
                        console.warn('Local data became empty after merge - attempting restore from backup');
                        if (restoreLocalData()) {
                            console.log('Successfully restored from backup');
                        }
                    }
                    loadWeekData();
                    renderPracticeGrid();
                    updateSummary();
                    if (!isSilentLoad) {
                        showStatus('Loaded from Drive', 'success');
                    }
                } else {
                    // Empty file, keep local data and sync it to Drive
                    console.log('Drive file is empty, keeping local data');
                    if (Object.keys(allWeeksData.weeks || {}).length > 0) {
                        setTimeout(() => syncData().catch(() => {}), 1000);
                    }
                    loadWeekData();
                    renderPracticeGrid();
                    updateSummary();
                    if (!isSilentLoad) {
                        showStatus('Signed in', 'success');
                    }
                }
            } catch (err) {
                // File might be empty or not exist yet, fall back to local data
                console.log('No existing data or error loading from Drive:', err);
                // DON'T overwrite local data - just render what we have
                // Make sure local data is preserved - restore from backup if lost
                if (Object.keys(allWeeksData.weeks || {}).length === 0) {
                    console.warn('WARNING: Local data is empty - attempting restore from backup');
                    if (restoreLocalData()) {
                        console.log('Successfully restored from backup');
                    } else {
                        console.error('No backup available to restore');
                    }
                }
                loadWeekData();
                renderPracticeGrid();
                updateSummary();
                // Don't show error status - just silently use local data
                if (!isSilentLoad) {
                    showStatus('Signed in', 'success');
                }
                // Sync local data to Drive in case Drive was empty
                if (accessToken && Object.keys(allWeeksData.weeks || {}).length > 0) {
                    setTimeout(() => syncData().catch(() => {}), 1000); // Sync after a delay, silent fail
                }
            }
        }

        async function syncData() {
            if (!accessToken) return;

            showStatus('Syncing...', 'loading');

            try {
                if (!fileId) {
                    fileId = await findOrCreateFile();
                }

                const dataStr = JSON.stringify(allWeeksData, null, 2);

                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: dataStr
                });

                if (response.ok) {
                    showStatus('Synced', 'success');
                } else {
                    showStatus('Sync failed', 'error');
                }
            } catch (err) {
                console.error('Sync error:', err);
                showStatus('Sync error', 'error');
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.style.color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--text-tertiary)';

            if (type === 'success' || type === 'loading') {
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 2000);
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            // Initialize Google APIs after page load
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            } else {
                console.warn('GAPI not loaded');
            }
            if (typeof google !== 'undefined') {
                gisLoaded();
            } else {
                console.warn('GIS not loaded');
            }
            
            // Final safety net - if button is still disabled after 6 seconds, force enable it
            setTimeout(() => {
                const btn = document.getElementById('authBtn');
                if (btn && btn.disabled) {
                    console.warn('Button still disabled after 6 seconds - force enabling');
                    btn.innerHTML = '<i data-lucide="log-in" class="w-4 h-4 inline mr-2"></i>Sign in with Google';
                    btn.disabled = false;
                    btn.classList.remove('btn-success');
                    lucide.createIcons();
                    showToast('Ready - click to sign in', 'success');
                }
            }, 6000);
            initDarkMode();
            document.getElementById('weekDate').value = setDateInputValue(new Date());
            loadWeekData();
            renderPracticeGrid();
            updateSummary();
            updateWeekRangeDisplay();
            lucide.createIcons();
        });
    </script>
</body>
</html>
