<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Data Migration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load local secrets -->
    <script src="airtable_secrets.js"></script>
    <!-- Load data -->
    <script src="migration_data.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
        <h1 class="text-2xl font-bold mb-4 text-center">Direct Migration</h1>
        <p class="text-gray-600 mb-6 text-center text-sm">
            Found 5 weeks of practice history. Ready to upload to Airtable.
        </p>

        <div id="step1" class="space-y-4">
            <button id="startBtn"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                Start Upload
            </button>
        </div>

        <div id="progressArea" class="hidden space-y-4">
            <div class="flex items-center justify-between text-sm font-medium">
                <span id="statusText">Initializing...</span>
                <span id="percentText">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                    style="width: 0%"></div>
            </div>
            <div id="logArea"
                class="h-48 overflow-y-auto bg-gray-50 p-2 rounded text-xs font-mono text-gray-600 border border-gray-200">
            </div>
        </div>

        <div id="successArea" class="hidden text-center space-y-4 mt-6">
            <div class="text-green-600 font-bold text-lg">
                <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2"></i>
                Upload Complete!
            </div>
            <a href="practice_tracker_sync.html"
                class="inline-block bg-gray-800 hover:bg-gray-900 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                Open Habit Tracker
            </a>
        </div>
    </div>

    <script>
        // Airtable Config
        const airtableConfig = {
            token: window.AIRTABLE_SECRETS ? window.AIRTABLE_SECRETS.token : '',
            baseId: window.AIRTABLE_SECRETS ? window.AIRTABLE_SECRETS.baseId : ''
        };

        // Initialize Lucide
        lucide.createIcons();

        // Helper: Log
        function log(msg) {
            const logArea = document.getElementById('logArea');
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(msg);
        }

        // Helper: Date from Week
        function getDateFromWeek(year, week, dayIndex) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());

            const targetDate = new Date(ISOweekStart);
            targetDate.setDate(ISOweekStart.getDate() + dayIndex);

            return targetDate.toISOString().split('T')[0];
        }

        // Airtable Service
        const AirtableService = {
            async createPractice(date, instrumentId, weekKey) {
                const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/Practices`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            "Date": date,
                            "Instrument": instrumentId,
                            "Week": weekKey
                        }
                    })
                });
                if (!response.ok) throw new Error(`Airtable Error: ${response.statusText}`);
                return await response.json();
            }
        };

        document.getElementById('startBtn').addEventListener('click', async () => {
            if (!airtableConfig.token || !airtableConfig.baseId) {
                alert('Missing credentials! Make sure airtable_secrets.js is loaded.');
                return;
            }

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('progressArea').classList.remove('hidden');

            const data = window.MIGRATION_DATA;
            const itemsToMigrate = [];

            Object.keys(data.weeks).forEach(weekKey => {
                const weekData = data.weeks[weekKey];
                Object.keys(weekData).forEach(key => {
                    if (!key.startsWith('_') && weekData[key]) {
                        const instrumentId = key.split('-')[0];
                        const dayIndex = parseInt(key.split('-')[1]);
                        const [year, weekNum] = weekKey.split('-W');

                        if (isNaN(year) || isNaN(weekNum)) {
                            log(`Skipping invalid week: ${weekKey}`);
                            return;
                        }

                        const simpleDate = getDateFromWeek(parseInt(year), parseInt(weekNum), dayIndex);

                        itemsToMigrate.push({
                            date: simpleDate,
                            instrument: instrumentId,
                            week: weekKey
                        });
                    }
                });
            });

            log(`Found ${itemsToMigrate.length} records to upload.`);

            let success = 0;
            let fail = 0;
            const total = itemsToMigrate.length;

            for (let i = 0; i < total; i++) {
                const item = itemsToMigrate[i];
                try {
                    await AirtableService.createPractice(item.date, item.instrument, item.week);
                    success++;
                    log(`Uploaded: ${item.date} - ${item.instrument}`);
                } catch (err) {
                    fail++;
                    log(`Failed: ${item.date} - ${err.message}`);
                }

                // Update UI
                const percent = Math.round(((i + 1) / total) * 100);
                document.getElementById('progressBar').style.width = `${percent}%`;
                document.getElementById('percentText').textContent = `${percent}%`;
                document.getElementById('statusText').textContent = `Uploading... ${i + 1}/${total}`;

                // Rate limit (5 req/sec)
                await new Promise(r => setTimeout(r, 250));
            }

            log(`Finished! Success: ${success}, Failed: ${fail}`);
            document.getElementById('progressArea').classList.add('hidden');
            document.getElementById('successArea').classList.remove('hidden');
        });

    </script>
</body>

</html>